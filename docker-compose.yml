networks:
  mysql:
    internal: true
  php:
    internal: false
  valkey:
    internal: true
secrets:
  db_password:
    file: './ops/secret'
  db_root_password:
    file: './ops/secret'
services:
  mysql:
    cap_drop:
      - 'ALL'
    command: '--log-error-suppression-list="MY-013360"'
    environment:
      MYSQL_DATABASE: 'db'
      MYSQL_PASSWORD_FILE: '/run/secrets/db_password'
      MYSQL_ROOT_PASSWORD_FILE: '/run/secrets/db_root_password'
      MYSQL_USER: 'db'
    healthcheck:
      interval: '10s'
      retries: 3
      start_period: '30s'
      test: ['CMD', 'mysqladmin', 'ping']
      timeout: '5s'
    image: 'mysql:8-oracle'
    logging:
      driver: 'json-file'
      options:
        max-file: 3
        max-size: '10m'
    networks:
      - 'mysql'
    read_only: true
    restart: 'unless-stopped'
    secrets:
      - 'db_password'
      - 'db_root_password'
    security_opt:
      - 'no-new-privileges:true'
    stop_grace_period: '60s'
    sysctls:
      - 'net.core.somaxconn=65535'
    tmpfs:
      - '/tmp:rw,nosuid,nodev,noexec,mode=1777,size=64m,noatime,nodiratime'
      - '/var/run:rw,nosuid,nodev,noexec,mode=1777,size=2m,noatime,nodiratime'
    ulimits:
      nofile:
        hard: 1048576
        soft: 1048576
    user: 'mysql:mysql'
    volumes:
      - 'mysql_data:/var/lib/mysql'
  nginx:
    build:
      context: './'
      dockerfile: './Dockerfile'
      target: 'nginx'
    cap_drop:
      - 'ALL'
    depends_on:
      php:
        condition: 'service_healthy'
    healthcheck:
      interval: '10s'
      retries: 3
      start_period: '30s'
      test: ['CMD-SHELL', 'curl -fsS http://localhost:8080/ping | grep -q pong || exit 1']
      timeout: '5s'
    logging:
      driver: 'json-file'
      options:
        max-file: 3
        max-size: '10m'
    networks:
      - php
    ports:
      - '8080:8080'
    read_only: true
    restart: 'unless-stopped'
    security_opt:
      - 'no-new-privileges:true'
    stop_grace_period: '60s'
    sysctls:
      - 'net.core.somaxconn=65535'
      - 'net.ipv4.ip_local_port_range=1024 65535'
      - 'net.ipv4.tcp_fin_timeout=15'
      - 'net.ipv4.tcp_tw_reuse=1'
    tmpfs:
      - '/tmp:rw,nosuid,nodev,noexec,mode=1777,size=64m,noatime,nodiratime'
      - '/var/run:rw,nosuid,nodev,noexec,mode=1777,size=2m,noatime,nodiratime'
    ulimits:
      nofile:
        hard: 1048576
        soft: 1048576
    user: 'nginx:nginx'
  php:
    build:
      context: './'
      dockerfile: './Dockerfile'
      target: 'php'
    cap_drop:
      - 'ALL'
    depends_on:
      mysql:
        condition: 'service_healthy'
      valkey:
        condition: 'service_healthy'
    environment:
      APP_ENV: 'production'
      MYSQL_DATABASE: 'db'
      MYSQL_HOST: 'mysql'
      MYSQL_PASSWORD_FILE: '/run/secrets/db_password'
      MYSQL_USER: 'db'
      NODE_ENV: 'production'
    healthcheck:
      interval: '10s'
      retries: 3
      start_period: '30s'
      test: ['CMD-SHELL', 'REQUEST_METHOD=GET SCRIPT_NAME=/ping SCRIPT_FILENAME=/ping cgi-fcgi -bind -connect localhost:9000 | grep -q pong || exit 1']
      timeout: '5s'
    logging:
      driver: 'json-file'
      options:
        max-file: 3
        max-size: '10m'
    networks:
      - mysql
      - php
      - valkey
    read_only: true
    restart: 'unless-stopped'
    secrets:
      - 'db_password'
    security_opt:
      - 'no-new-privileges:true'
    stop_grace_period: '60s'
    sysctls:
      - 'net.core.somaxconn=65535'
    tmpfs:
      - '/tmp:rw,nosuid,nodev,noexec,mode=1777,size=64m,noatime,nodiratime'
      - '/var/run:rw,nosuid,nodev,noexec,mode=1777,size=2m,noatime,nodiratime'
    ulimits:
      nofile:
        hard: 1048576
        soft: 1048576
    user: 'www-data:www-data'
  valkey:
    cap_drop:
      - 'ALL'
    healthcheck:
      interval: '10s'
      retries: 3
      start_period: '30s'
      test: ['CMD', 'valkey-cli', 'ping']
      timeout: '5s'
    image: 'valkey/valkey:9-trixie'
    logging:
      driver: 'json-file'
      options:
        max-file: 3
        max-size: '10m'
    networks:
      - valkey
    read_only: true
    restart: 'unless-stopped'
    security_opt:
      - 'no-new-privileges:true'
    stop_grace_period: '60s'
    sysctls:
      - 'net.core.somaxconn=65535'
    tmpfs:
      - '/tmp:rw,nosuid,nodev,noexec,mode=1777,size=64m,noatime,nodiratime'
      - '/var/run:rw,nosuid,nodev,noexec,mode=1777,size=2m,noatime,nodiratime'
    ulimits:
      nofile:
        hard: 1048576
        soft: 1048576
    user: 'valkey:valkey'
    volumes:
      - 'valkey_data:/data'
volumes:
  mysql_data:
  valkey_data:
